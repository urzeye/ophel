name: "ğŸš€ Build & Release Extension"

on:
  push:
    tags:
      - "v*.*.*" # åŒ¹é… v1.0.0, v1.2.3 ç­‰æ ¼å¼çš„ tag
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬å· (å¦‚ v1.0.0)"
        required: true
        default: "v1.0.0"

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # éœ€è¦å†™æƒé™æ¥åˆ›å»º release

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all platforms
        run: pnpm build:all

      - name: Build Userscript
        run: pnpm build:userscript

      - name: Package all platforms
        run: pnpm package:all

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Extract Changelog
        id: extract_changelog
        run: |
          VERSION=${{ steps.get_version.outputs.VERSION }}
          VERSION_NO_V=${VERSION#v}

          # ä½¿ç”¨ awk æå–å¯¹åº”ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—
          # åŒ¹é… "## [1.0.1]" å¼€å¤´ï¼Œåˆ°ä¸‹ä¸€ä¸ª "## [" ä¹‹å‰çš„å†…å®¹
          awk -v ver="\\[${VERSION_NO_V}\\]" '
            /^## \[/ { 
              if (p) exit; 
              if ($0 ~ ver) { p=1; next } 
            } 
            p
          ' CHANGELOG.md > RELEASE_NOTE.md

          # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”ç‰ˆæœ¬çš„æ—¥å¿—ï¼Œä½¿ç”¨å ä½ç¬¦
          if [ ! -s RELEASE_NOTE.md ]; then
            echo "è¯¦è§ CHANGELOG.md" > RELEASE_NOTE.md
          fi

          # è¾“å‡ºåˆ° GITHUB_OUTPUT (æ”¯æŒå¤šè¡Œ)
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          cat RELEASE_NOTE.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Package for Chrome Web Store
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•å¹¶å¤åˆ¶æ„å»ºäº§ç‰©
          cp -r build/chrome-mv3-prod build/chrome-mv3-cws

          # ä» manifest.json ä¸­å½»åº•åˆ é™¤ key å­—æ®µ
          node -e "
            const fs = require('fs');
            const manifestPath = 'build/chrome-mv3-cws/manifest.json';
            const pkg = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
            if (pkg.key) { delete pkg.key; }
            fs.writeFileSync(manifestPath, JSON.stringify(pkg, null, 2));
          "

          # æ‰“åŒ…ä¸º zip
          cd build/chrome-mv3-cws
          zip -r ../ophel-cws-upload.zip .
          cd ../..

      - name: Rename artifacts for release
        run: |
          cp build/chrome-mv3-prod.zip build/ophel-${{ steps.get_version.outputs.VERSION }}-chrome.zip
          cp build/chrome-mv3-prod.zip build/ophel-${{ steps.get_version.outputs.VERSION }}-edge.zip
          cp build/firefox-mv3-prod.zip build/ophel-${{ steps.get_version.outputs.VERSION }}-firefox.zip
          cp build/userscript/ophel.user.js build/ophel-${{ steps.get_version.outputs.VERSION }}.user.js
          cp build/ophel-cws-upload.zip build/ophel-${{ steps.get_version.outputs.VERSION }}-cws-upload.zip

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Ophel ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Ophel ${{ steps.get_version.outputs.VERSION }}

            ${{ steps.extract_changelog.outputs.notes }}

            ---

            | Platform / å¹³å° | File / æ–‡ä»¶ | Note / è¯´æ˜ |
            |-----------------|-------------|-------------|
            | **Chrome** | `ophel-${{ steps.get_version.outputs.VERSION }}-chrome.zip` | **Recommended / æ¨è** (Consistent ID / ID ä¸€è‡´) |
            | **Edge** | `ophel-${{ steps.get_version.outputs.VERSION }}-edge.zip` | Edge Add-ons or Load Unpacked |
            | **Firefox** | `ophel-${{ steps.get_version.outputs.VERSION }}-firefox.zip` | Firefox Add-ons |
            | **Userscript** | `ophel-${{ steps.get_version.outputs.VERSION }}.user.js` | Tampermonkey script |
            | **CWS Upload** | `ophel-${{ steps.get_version.outputs.VERSION }}-cws-upload.zip` | **For Store Upload Only / ä»…ä¾›å•†åº—ä¸Šä¼ ** (No Key) |

            ### ğŸ”§ Installation / å®‰è£…æ–¹æ³•

            #### Chrome / Edge (Recommended)
            1. Download `ophel-...-chrome.zip`. / ä¸‹è½½ Chrome ç‰ˆæœ¬å‹ç¼©åŒ…ã€‚
            2. Unzip and load unpacked in Developer Mode. / è§£å‹å¹¶åœ¨å¼€å‘è€…æ¨¡å¼ä¸‹åŠ è½½å·²è§£å‹çš„æ‰©å±•ã€‚

            > **Note:** This version includes the public key, ensuring your Extension ID matches the Chrome Web Store version.
            > **æ³¨æ„ï¼š** æ­¤ç‰ˆæœ¬åŒ…å«å…¬é’¥ï¼Œç¡®ä¿æ‚¨çš„æ‰©å±• ID ä¸ Chrome å•†åº—ç‰ˆæœ¬ä¸€è‡´ï¼Œä»¥ä¿è¯æ•°æ®äº’é€šã€‚

            #### Userscript (Tampermonkey) / æ²¹çŒ´è„šæœ¬
            1. Install [Tampermonkey](https://www.tampermonkey.net/). / å®‰è£… Tampermonkey æ’ä»¶ã€‚
            2. Click the `.user.js` file link. / ç‚¹å‡» `.user.js` æ–‡ä»¶é“¾æ¥å³å¯å®‰è£…ã€‚

            ---
            *Full Changelog / å®Œæ•´æ›´æ–°æ—¥å¿—: [CHANGELOG.md](https://github.com/urzeye/ophel/blob/main/CHANGELOG.md)*
          files: |
            build/ophel-${{ steps.get_version.outputs.VERSION }}-chrome.zip
            build/ophel-${{ steps.get_version.outputs.VERSION }}-edge.zip
            build/ophel-${{ steps.get_version.outputs.VERSION }}-firefox.zip
            build/ophel-${{ steps.get_version.outputs.VERSION }}.user.js
            build/ophel-${{ steps.get_version.outputs.VERSION }}-cws-upload.zip
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy README for Userscript
        run: |
          cp README*.md build/userscript/
          mkdir -p build/userscript/docs/i18n
          cp docs/i18n/README*.md build/userscript/docs/i18n/ 2>/dev/null || true
          # æ›¿æ¢æœ¬åœ°å›¾ç‰‡è·¯å¾„ä¸ºç½‘ç»œ URLï¼ˆæ²¹çŒ´è„šæœ¬ release åˆ†æ”¯éœ€è¦ï¼‰
          sed -i 's|./assets/icon.png|https://gist.github.com/user-attachments/assets/cdd08324-3962-4270-87a3-474b5d240f03|g' build/userscript/README*.md
          sed -i 's|../../assets/icon.png|https://gist.github.com/user-attachments/assets/cdd08324-3962-4270-87a3-474b5d240f03|g' build/userscript/docs/i18n/README*.md

      - name: Deploy Userscript to release branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/userscript
          publish_branch: release
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"
          commit_message: "Deploy userscript ${{ steps.get_version.outputs.VERSION }} [skip ci]"
          force_orphan: true
