# Ophel Extension CSS æ¶æ„æŒ‡å—

> æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜é¡¹ç›®ä¸­ CSS çš„ä½¿ç”¨æ–¹æ³•ã€æ³¨å…¥æœºåˆ¶å’Œçº¦æŸæ¡ä»¶ã€‚
> ä¾›å¼€å‘è€…å’Œ AI åˆ†æé—®é¢˜æ—¶å‚è€ƒã€‚

---

## ğŸ“‹ ç›®å½•

1. [æ ¸å¿ƒæ¦‚å¿µï¼šæ‰§è¡Œç¯å¢ƒä¸æ ·å¼éš”ç¦»](#1-æ ¸å¿ƒæ¦‚å¿µæ‰§è¡Œç¯å¢ƒä¸æ ·å¼éš”ç¦»)
2. [CSS æ–‡ä»¶åˆ†ç±»ä¸ç”¨é€”](#2-css-æ–‡ä»¶åˆ†ç±»ä¸ç”¨é€”)
3. [æ ·å¼æ³¨å…¥æœºåˆ¶è¯¦è§£](#3-æ ·å¼æ³¨å…¥æœºåˆ¶è¯¦è§£)
4. [ä¸»é¢˜ç³»ç»Ÿæ¶æ„](#4-ä¸»é¢˜ç³»ç»Ÿæ¶æ„)
5. [æ ·å¼æ–‡ä»¶ç´¢å¼•](#5-æ ·å¼æ–‡ä»¶ç´¢å¼•)
6. [å¸¸è§é—®é¢˜ä¸é™·é˜±](#6-å¸¸è§é—®é¢˜ä¸é™·é˜±)
7. [å†³ç­–æ ‘ï¼šå¦‚ä½•æ·»åŠ æ–°æ ·å¼](#7-å†³ç­–æ ‘å¦‚ä½•æ·»åŠ æ–°æ ·å¼)

---

## 1. æ ¸å¿ƒæ¦‚å¿µï¼šæ‰§è¡Œç¯å¢ƒä¸æ ·å¼éš”ç¦»

### 1.1 ä¸‰ç§æ‰§è¡Œç¯å¢ƒ

é¡¹ç›®æ¶‰åŠä¸‰ç§ä¸åŒçš„ JavaScript/CSS æ‰§è¡Œç¯å¢ƒï¼Œç†è§£å®ƒä»¬çš„è¾¹ç•Œæ˜¯æ­£ç¡®ä½¿ç”¨æ ·å¼çš„å…³é”®ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æµè§ˆå™¨æ ‡ç­¾é¡µ                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   éš”ç¦»ä¸–ç•Œ        â”‚      ä¸»ä¸–ç•Œ             â”‚        Shadow DOM            â”‚
â”‚  (Isolated)      â”‚     (Main)              â”‚      (Encapsulated)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Content Script  â”‚ é¡µé¢è„šæœ¬ (Gemini)        â”‚ Plasmo CSUI                  â”‚
â”‚ é»˜è®¤è¿è¡Œç¯å¢ƒ      â”‚ scroll-lock-main.ts     â”‚ <plasmo-csui>                â”‚
â”‚                 â”‚                         â”‚                              â”‚
â”‚ â€¢ å¯è®¿é—® DOM     â”‚ â€¢ å¯ä¿®æ”¹å…¨å±€ API         â”‚ â€¢ æ ·å¼å®Œå…¨éš”ç¦»               â”‚
â”‚ â€¢ æ— æ³•ä¿®æ”¹åŸå‹é“¾  â”‚ â€¢ å— CSP é™åˆ¶           â”‚ â€¢ éœ€è¦ç‰¹æ®Šæ–¹å¼æ³¨å…¥ CSS       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 Shadow DOM æ ·å¼éš”ç¦»

**å…³é”®è§„åˆ™**ï¼šShadow DOM å†…çš„å…ƒç´ åªèƒ½è¢« Shadow DOM å†…éƒ¨çš„æ ·å¼å½±å“ã€‚

```
å¤–éƒ¨æ ·å¼è¡¨ â”€â”€â†’ æ— æ³•ç©¿é€ â”€â”€â†’ Shadow DOM å†…éƒ¨å…ƒç´ 
                â”‚
                â†“
       å¿…é¡»é€šè¿‡ getStyle() æ³¨å…¥
```

Plasmo æ¡†æ¶å°† React ç»„ä»¶æ¸²æŸ“åœ¨ `<plasmo-csui>` å…ƒç´ çš„ Shadow DOM å†…ï¼š

```html
<plasmo-csui>
  #shadow-root (open)
    <style>/* é€šè¿‡ getStyle() æ³¨å…¥çš„æ ·å¼ */</style>
    <div class="gh-root">
      <!-- æ’ä»¶ UI ç»„ä»¶ -->
    </div>
</plasmo-csui>
```

### 1.3 Gemini Enterprise çš„åŒé‡ Shadow DOM

Gemini Enterprise (business.gemini.google) é¡µé¢æœ¬èº«ä½¿ç”¨ Shadow DOMï¼š

```
document
â””â”€â”€ é¡µé¢å…ƒç´ 
    â””â”€â”€ <ucs-fast-markdown>
        â””â”€â”€ #shadow-root (Gemini çš„ Shadow DOM)
            â””â”€â”€ ç”¨æˆ·æé—®å†…å®¹
```

è¿™æ„å‘³ç€æŸäº›åŠŸèƒ½ï¼ˆå¦‚ç”¨æˆ·æé—® Markdown æ¸²æŸ“ï¼‰éœ€è¦å°†æ ·å¼æ³¨å…¥åˆ° **Gemini çš„ Shadow DOM** ä¸­ï¼Œè€Œä¸æ˜¯ Plasmo çš„ã€‚

---

## 2. CSS æ–‡ä»¶åˆ†ç±»ä¸ç”¨é€”

### 2.1 é™æ€ CSS æ–‡ä»¶ï¼ˆé€šè¿‡ Plasmo `getStyle()` æ³¨å…¥ï¼‰

è¿™äº›æ–‡ä»¶çš„æ ·å¼ä¼šè¢«æ³¨å…¥åˆ° **Plasmo çš„ Shadow DOM** ä¸­ï¼Œç”¨äºæ’ä»¶ UI ç»„ä»¶ã€‚

| æ–‡ä»¶ | ç”¨é€” | æ³¨å…¥æ–¹å¼ |
|------|------|----------|
| `src/style.css` | ä¸»æ ·å¼æ–‡ä»¶ï¼ŒåŒ…å«é¢æ¿ã€å¤§çº²ã€å·¥å…·æ ç­‰æ ¸å¿ƒ UI æ ·å¼ | `data-text:~style.css` |
| `src/styles/conversations.css` | ä¼šè¯ Tab ä¸“ç”¨æ ·å¼ï¼Œä»æ²¹çŒ´è„šæœ¬è¿ç§» | `data-text:~styles/conversations.css` |
| `src/styles/theme-variables.css` | CSS å˜é‡å®šä¹‰ï¼ˆæµ…è‰²/æ·±è‰²æ¨¡å¼é»˜è®¤å€¼ï¼‰ | è¢« `style.css` é€šè¿‡ `@import` å¼•å…¥ |

**æ³¨å…¥ä»£ç ** (`src/contents/ui-entry.tsx`)ï¼š

```typescript
import cssText from "data-text:~style.css"
import conversationsCssText from "data-text:~styles/conversations.css"

export const getStyle = () => {
  const style = document.createElement("style")
  style.textContent = cssText + "\n" + conversationsCssText
  return style
}
```

### 2.2 åŠ¨æ€æ³¨å…¥çš„ CSSï¼ˆå†…åµŒåœ¨ TypeScript ä¸­ï¼‰

è¿™äº›æ ·å¼éœ€è¦åŠ¨æ€æ³¨å…¥åˆ°**ä¸»ä¸–ç•Œçš„ `document.head`** æˆ– **Gemini çš„ Shadow DOM** ä¸­ï¼Œå› æ­¤ä½œä¸ºå­—ç¬¦ä¸²å†…åµŒåœ¨ TS æ–‡ä»¶é‡Œã€‚

| æ–‡ä»¶ | æ ·å¼ç”¨é€” | æ³¨å…¥ç›®æ ‡ |
|------|----------|----------|
| `src/core/user-query-markdown.ts` | ç”¨æˆ·æé—® Markdown æ¸²æŸ“æ ·å¼ | ä¸»ä¸–ç•Œ `document.head` æˆ– Gemini Shadow DOM |
| `src/utils/markdown.ts` (`getHighlightStyles()`) | ä»£ç é«˜äº®æ ·å¼ (highlight.js) | å¤šä¸ªä¸Šä¸‹æ–‡å¤ç”¨ |
| `src/core/theme-manager.ts` | View Transitions åŠ¨ç”»æ ·å¼ | ä¸»ä¸–ç•Œ `document.head` |

**ä¸ºä»€ä¹ˆä¸æŠ½ç¦»æˆç‹¬ç«‹ CSS æ–‡ä»¶ï¼Ÿ**

1. **æ³¨å…¥ç›®æ ‡ä¸æ˜¯ Plasmo Shadow DOM**ï¼š`getStyle()` åªèƒ½æ³¨å…¥åˆ° Plasmo çš„ Shadow DOM
2. **éœ€è¦åœ¨è¿è¡Œæ—¶åŠ¨æ€æ³¨å…¥**ï¼šæ ¹æ®é¡µé¢ç±»å‹ï¼ˆæ™®é€šç‰ˆ/Enterpriseï¼‰æ³¨å…¥åˆ°ä¸åŒä½ç½®
3. **éœ€è¦ä½œä¸ºå­—ç¬¦ä¸²æ‹¼æ¥**ï¼šä¸å…¶ä»–æ ·å¼ç»„åˆåæ³¨å…¥

```typescript
// user-query-markdown.ts çš„æ³¨å…¥é€»è¾‘
private injectGlobalStyles() {
  const style = document.createElement("style")
  style.textContent = getHighlightStyles() + "\n" + USER_QUERY_MARKDOWN_CSS
  document.head.appendChild(style)  // æ³¨å…¥åˆ°ä¸»ä¸–ç•Œ
}

private injectStyleToShadowRoot(shadowRoot: ShadowRoot) {
  // Gemini Enterpriseï¼šæ³¨å…¥åˆ°é¡µé¢çš„ Shadow DOM
  const style = document.createElement("style")
  style.textContent = getHighlightStyles() + "\n" + USER_QUERY_MARKDOWN_CSS
  shadowRoot.prepend(style)
}
```

### 2.3 ä¸»é¢˜é¢„ç½®ï¼ˆTypeScript å¯¹è±¡ï¼‰

ä¸»é¢˜å˜é‡å®šä¹‰åœ¨ TypeScript ä¸­ï¼Œä»¥ä¾¿æ”¯æŒå¤šä¸»é¢˜é¢„ç½®ç³»ç»Ÿã€‚

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| `src/utils/themes/index.ts` | ä¸»é¢˜ç³»ç»Ÿå…¥å£ï¼Œå¯¼å‡ºé¢„ç½®åˆ—è¡¨å’Œå·¥å…·å‡½æ•° |
| `src/utils/themes/types.ts` | ç±»å‹å®šä¹‰ (`ThemePreset`, `ThemeVariables`) |
| `src/utils/themes/light/index.ts` | æµ…è‰²ä¸»é¢˜é¢„ç½® (10+ ç§é…è‰²æ–¹æ¡ˆ) |
| `src/utils/themes/dark/index.ts` | æ·±è‰²ä¸»é¢˜é¢„ç½® (10+ ç§é…è‰²æ–¹æ¡ˆ) |

---

## 3. æ ·å¼æ³¨å…¥æœºåˆ¶è¯¦è§£

### 3.1 Plasmo Shadow DOM æ ·å¼æ³¨å…¥æµç¨‹

```
ç¼–è¯‘æ—¶:
  style.css + conversations.css
       â”‚
       â†“ (data-text: å¯¼å…¥)
  ui-entry.tsx ä¸­çš„ getStyle()
       â”‚
       â†“ (Plasmo æ¡†æ¶è°ƒç”¨)
è¿è¡Œæ—¶:
  åˆ›å»º <style> å…ƒç´ 
       â”‚
       â†“
  æ’å…¥åˆ° <plasmo-csui> çš„ Shadow Root ä¸­
```

### 3.2 ä¸»é¢˜å˜é‡åŠ¨æ€æ³¨å…¥æµç¨‹

```
ThemeManager.syncPluginUITheme()
       â”‚
       â†“
  1. ä»é¢„ç½®ç³»ç»Ÿè·å– CSS å˜é‡å¯¹è±¡
       â”‚
       â†“
  2. ç”Ÿæˆ :host { --gh-bg: ...; } æ ·å¼æ–‡æœ¬
       â”‚
       â†“
  3. æ’å…¥/æ›´æ–° Shadow Root ä¸­çš„ <style id="gh-theme-vars">
       â”‚
       â†“ (å…³é”®!)
  4. ä½¿ç”¨ shadowRoot.append() å°†æ ·å¼ç§»åˆ°æœ«å°¾
      ä»¥ç¡®ä¿è¦†ç›– getStyle() æ³¨å…¥çš„é»˜è®¤æ ·å¼
```

**ä¸ºä»€ä¹ˆéœ€è¦ `append()` åˆ°æœ«å°¾ï¼Ÿ**

CSS ä¼˜å…ˆçº§è§„åˆ™ï¼šå½“é€‰æ‹©å™¨ç‰¹å¼‚æ€§ç›¸åŒæ—¶ï¼Œåå‡ºç°çš„è§„åˆ™è¦†ç›–å…ˆå‡ºç°çš„ã€‚

```
<plasmo-csui>
  #shadow-root
    <style>/* getStyle() æ³¨å…¥ï¼ŒåŒ…å«é»˜è®¤æµ…è‰²å˜é‡ */</style>
    <style id="gh-theme-vars">/* ä¸»é¢˜å˜é‡ï¼Œå¿…é¡»åœ¨åé¢ */</style>
    <div class="gh-root">...</div>
```

### 3.3 ç”¨æˆ·æé—® Markdown æ ·å¼æ³¨å…¥æµç¨‹

```
UserQueryMarkdownRenderer åˆå§‹åŒ–
       â”‚
       â”œâ”€ æ™®é€šç«™ç‚¹ (gemini.google.com)
       â”‚       â”‚
       â”‚       â†“
       â”‚   injectGlobalStyles()
       â”‚       â”‚
       â”‚       â†“
       â”‚   document.head.appendChild(style)
       â”‚
       â””â”€ Shadow DOM ç«™ç‚¹ (business.gemini.google)
               â”‚
               â†“
           injectStyleToShadowRoot(shadowRoot)
               â”‚
               â†“
           geminiShadowRoot.prepend(style)
```

---

## 4. ä¸»é¢˜ç³»ç»Ÿæ¶æ„

### 4.1 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ä¸»é¢˜ç³»ç»Ÿæ¶æ„                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ theme-variables â”‚     â”‚  themes/light/  â”‚                        â”‚
â”‚  â”‚      .css       â”‚     â”‚    index.ts     â”‚                        â”‚
â”‚  â”‚                 â”‚     â”‚                 â”‚                        â”‚
â”‚  â”‚ é»˜è®¤ CSS å˜é‡    â”‚     â”‚ æµ…è‰²é¢„ç½®æ–¹æ¡ˆ     â”‚                        â”‚
â”‚  â”‚ (é™æ€æ³¨å…¥)       â”‚     â”‚ (10+ ç§é…è‰²)     â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚           â”‚                       â”‚                                 â”‚
â”‚           â†“                       â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚            ThemeManager                  â”‚                        â”‚
â”‚  â”‚                                          â”‚                        â”‚
â”‚  â”‚  â€¢ æ£€æµ‹é¡µé¢ä¸»é¢˜ (light/dark)             â”‚                        â”‚
â”‚  â”‚  â€¢ æ ¹æ®ç”¨æˆ·é€‰æ‹©åŠ è½½é¢„ç½®                  â”‚                        â”‚
â”‚  â”‚  â€¢ ç”Ÿæˆ CSS å˜é‡å¹¶æ³¨å…¥åˆ° Shadow DOM     â”‚                        â”‚
â”‚  â”‚  â€¢ ç›‘å¬é¡µé¢ä¸»é¢˜å˜åŒ– (MutationObserver)  â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                       â”‚                                             â”‚
â”‚                       â†“                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚  <style id="gh-theme-vars">             â”‚                        â”‚
â”‚  â”‚    :host {                              â”‚                        â”‚
â”‚  â”‚      --gh-bg: #1e1e1e;                  â”‚                        â”‚
â”‚  â”‚      --gh-text: #e3e3e3;                â”‚                        â”‚
â”‚  â”‚      ...                                â”‚                        â”‚
â”‚  â”‚    }                                    â”‚                        â”‚
â”‚  â”‚  </style>                               â”‚                        â”‚
â”‚  â”‚                                          â”‚                        â”‚
â”‚  â”‚  åŠ¨æ€æ³¨å…¥åˆ° plasmo-csui Shadow Root     â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 CSS å˜é‡å‘½åè§„èŒƒ

æ‰€æœ‰ CSS å˜é‡ä½¿ç”¨ `--gh-` å‰ç¼€ï¼ˆGemini Helperï¼‰ï¼š

| å˜é‡ç±»åˆ« | ç¤ºä¾‹ | è¯´æ˜ |
|----------|------|------|
| èƒŒæ™¯è‰² | `--gh-bg`, `--gh-bg-secondary` | åŸºç¡€èƒŒæ™¯é¢œè‰² |
| æ–‡å­—è‰² | `--gh-text`, `--gh-text-secondary` | æ–‡å­—é¢œè‰²å±‚çº§ |
| è¾¹æ¡† | `--gh-border`, `--gh-border-active` | è¾¹æ¡†é¢œè‰² |
| äº¤äº’çŠ¶æ€ | `--gh-hover`, `--gh-active-bg` | æ‚¬åœ/ç‚¹å‡»çŠ¶æ€ |
| å“ç‰Œè‰² | `--gh-primary`, `--gh-header-bg` | ä¸»é¢˜è‰²/æ¸å˜ |
| é˜´å½± | `--gh-shadow`, `--gh-shadow-sm` | é˜´å½±æ•ˆæœ |
| è¾“å…¥æ¡† | `--gh-input-bg`, `--gh-input-border` | è¡¨å•å…ƒç´  |
| å¤§çº² | `--gh-outline-locate-bg` | å¤§çº²é¢æ¿ä¸“ç”¨ |
| å±é™©æ“ä½œ | `--gh-danger`, `--gh-text-danger` | åˆ é™¤/è­¦å‘Š |

### 4.3 ä¸»é¢˜é¢„ç½®ç»“æ„

```typescript
// src/utils/themes/types.ts
export interface ThemePreset {
  id: string         // å”¯ä¸€æ ‡è¯†ï¼Œå¦‚ "google-gradient"
  name: string       // æ˜¾ç¤ºåç§°ï¼Œå¦‚ "Google æ¸å˜"
  description: string
  variables: ThemeVariables  // CSS å˜é‡é”®å€¼å¯¹
}

// ç¤ºä¾‹
{
  id: "classic-dark",
  name: "ç»å…¸æ·±é»‘",
  description: "é»˜è®¤æ·±è‰²ä¸»é¢˜",
  variables: {
    "--gh-bg": "#1e1e1e",
    "--gh-text": "#e3e3e3",
    // ... çº¦ 50+ ä¸ªå˜é‡
  }
}
```

---

## 5. æ ·å¼æ–‡ä»¶ç´¢å¼•

### 5.1 å®Œæ•´æ–‡ä»¶æ¸…å•

```
src/
â”œâ”€â”€ style.css                          # ä¸»æ ·å¼æ–‡ä»¶
â”œâ”€â”€ styles/
â”‚   â”œâ”€â”€ theme-variables.css            # CSS å˜é‡é»˜è®¤å€¼
â”‚   â””â”€â”€ conversations.css              # ä¼šè¯ Tab æ ·å¼
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ themes.ts                      # ä¸»é¢˜ç³»ç»Ÿå…¥å£
â”‚   â”œâ”€â”€ themes/
â”‚   â”‚   â”œâ”€â”€ index.ts                   # é¢„ç½®åˆ—è¡¨å’Œå·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ types.ts                   # ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ light/index.ts             # æµ…è‰²é¢„ç½® (10+ ç§)
â”‚   â”‚   â””â”€â”€ dark/index.ts              # æ·±è‰²é¢„ç½® (10+ ç§)
â”‚   â””â”€â”€ markdown.ts                    # getHighlightStyles() - ä»£ç é«˜äº®æ ·å¼
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ theme-manager.ts               # ä¸»é¢˜ç®¡ç†å™¨ (View Transitions æ ·å¼)
â”‚   â””â”€â”€ user-query-markdown.ts         # ç”¨æˆ·æé—® Markdown æ ·å¼
â””â”€â”€ contents/
    â””â”€â”€ ui-entry.tsx                   # getStyle() - é™æ€æ ·å¼æ³¨å…¥
```

### 5.2 æ ·å¼æ¥æºé€ŸæŸ¥è¡¨

| æ ·å¼ç±»å‹ | å®šä¹‰ä½ç½® | æ³¨å…¥ç›®æ ‡ | æ³¨å…¥æ–¹å¼ |
|----------|----------|----------|----------|
| é¢æ¿æ¡†æ¶ | `style.css` | Plasmo Shadow DOM | `getStyle()` |
| å¤§çº²ç»„ä»¶ | `style.css` | Plasmo Shadow DOM | `getStyle()` |
| ä¼šè¯åˆ—è¡¨ | `conversations.css` | Plasmo Shadow DOM | `getStyle()` |
| æç¤ºè¯ Tab | `style.css` | Plasmo Shadow DOM | `getStyle()` |
| CSS å˜é‡é»˜è®¤å€¼ | `theme-variables.css` | Plasmo Shadow DOM | `@import` by style.css |
| ä¸»é¢˜é¢„ç½®å˜é‡ | `themes/light/*.ts`, `themes/dark/*.ts` | Plasmo Shadow DOM | `ThemeManager` åŠ¨æ€æ³¨å…¥ |
| ä»£ç é«˜äº® | `markdown.ts` | å¤šä¸ªä¸Šä¸‹æ–‡ | å‡½æ•°è¿”å›å­—ç¬¦ä¸² |
| ç”¨æˆ·æé—®æ¸²æŸ“ | `user-query-markdown.ts` | ä¸»ä¸–ç•Œ / Gemini Shadow DOM | åŠ¨æ€åˆ›å»º `<style>` |
| View Transitions | `theme-manager.ts` | ä¸»ä¸–ç•Œ `document.head` | åŠ¨æ€åˆ›å»º `<style>` |

---

## 6. å¸¸è§é—®é¢˜ä¸é™·é˜±

### 6.1 Shadow DOM æ ·å¼ä¸ç”Ÿæ•ˆ

**ç—‡çŠ¶**ï¼šåœ¨ç»„ä»¶ä¸­ `import` çš„ CSS å®Œå…¨ä¸ç”Ÿæ•ˆã€‚

**åŸå› **ï¼šæ™®é€š `import` çš„ CSS æ— æ³•ç©¿é€ Shadow DOMã€‚

**è§£å†³**ï¼š

1. ä½¿ç”¨ `data-text:` å‰ç¼€å¯¼å…¥ä¸ºå­—ç¬¦ä¸²
2. åœ¨ `ui-entry.tsx` çš„ `getStyle()` ä¸­åˆå¹¶

```typescript
// âŒ é”™è¯¯
import "./my-component.css"

// âœ… æ­£ç¡®
// ui-entry.tsx
import myComponentCss from "data-text:~styles/my-component.css"
export const getStyle = () => {
  style.textContent = cssText + "\n" + myComponentCss
  return style
}
```

### 6.2 ä¸»é¢˜å˜é‡è¢«è¦†ç›–

**ç—‡çŠ¶**ï¼šæ·±è‰²æ¨¡å¼ä¸‹æŸäº›å˜é‡ä»æ˜¾ç¤ºæµ…è‰²å€¼ã€‚

**åŸå› **ï¼š`getStyle()` æ³¨å…¥çš„æ ·å¼åœ¨åŠ¨æ€ä¸»é¢˜æ ·å¼ä¹‹åã€‚

**è§£å†³**ï¼šç¡®ä¿ `ThemeManager` ä½¿ç”¨ `shadowRoot.append()` å°†ä¸»é¢˜æ ·å¼ç§»åˆ°æœ«å°¾ã€‚

### 6.3 æ ·å¼å†²çª

**ç—‡çŠ¶**ï¼šä¸åŒæ¥æºçš„æ ·å¼ç›¸äº’è¦†ç›–ï¼ˆå¦‚ä»£ç å—æ ·å¼ï¼‰ã€‚

**æ¡ˆä¾‹**ï¼š`getHighlightStyles()` ä¸­çš„ `.hljs` ä¸ `user-query-markdown.ts` ä¸­çš„æ ·å¼å†²çªã€‚

**è§£å†³**ï¼š

1. è°ƒæ•´ CSS åŠ è½½é¡ºåºï¼ˆå…ˆåŠ è½½å¯è¢«è¦†ç›–çš„ï¼‰
2. ä½¿ç”¨æ›´å…·ä½“çš„é€‰æ‹©å™¨ï¼ˆå¦‚ `.gh-user-query-markdown pre code`ï¼‰

### 6.4 View Transitions æ ·å¼ä¸ç”Ÿæ•ˆ

**ç—‡çŠ¶**ï¼šä¸»é¢˜åˆ‡æ¢åŠ¨ç”»ä¸æ˜¾ç¤ºæˆ–é—ªçƒã€‚

**åŸå› **ï¼š`::view-transition-*` ä¼ªå…ƒç´ åœ¨ Document Root ä¸Šï¼ŒShadow DOM å†…çš„æ ·å¼æ— æ³•å½±å“ã€‚

**è§£å†³**ï¼šåœ¨ `ThemeManager.injectGlobalStyles()` ä¸­å‘ `document.head` æ³¨å…¥ã€‚

---

## 7. å†³ç­–æ ‘ï¼šå¦‚ä½•æ·»åŠ æ–°æ ·å¼

```
å¼€å§‹ï¼šæˆ‘éœ€è¦æ·»åŠ æ–°æ ·å¼
       â”‚
       â†“
è¿™äº›æ ·å¼ç”¨äºä»€ä¹ˆï¼Ÿ
       â”‚
       â”œâ”€ æ’ä»¶ UI ç»„ä»¶ (é¢æ¿/Tab/å¼¹çª—)
       â”‚       â”‚
       â”‚       â†“
       â”‚   æ·»åŠ åˆ° style.css æˆ–åˆ›å»ºæ–° CSS æ–‡ä»¶
       â”‚   å¹¶åœ¨ ui-entry.tsx ä¸­åˆå¹¶
       â”‚
       â”œâ”€ éœ€è¦æ³¨å…¥åˆ°ä¸»ä¸–ç•Œ (é¡µé¢å¢å¼ºåŠŸèƒ½)
       â”‚       â”‚
       â”‚       â†“
       â”‚   åœ¨ TS æ–‡ä»¶ä¸­å†…åµŒ CSS å­—ç¬¦ä¸²
       â”‚   ä½¿ç”¨ document.head.appendChild() æ³¨å…¥
       â”‚
       â”œâ”€ éœ€è¦æ³¨å…¥åˆ°ç¬¬ä¸‰æ–¹ Shadow DOM (Gemini Enterprise)
       â”‚       â”‚
       â”‚       â†“
       â”‚   åœ¨ TS æ–‡ä»¶ä¸­å†…åµŒ CSS å­—ç¬¦ä¸²
       â”‚   ä½¿ç”¨ shadowRoot.prepend() æ³¨å…¥
       â”‚
       â””â”€ å…¨å±€åŠ¨ç”»/è¿‡æ¸¡æ•ˆæœ
               â”‚
               â†“
           åœ¨ ThemeManager.injectGlobalStyles() ä¸­æ·»åŠ 
           æˆ–åˆ›å»ºä¸“é—¨çš„å…¨å±€æ ·å¼æ³¨å…¥å‡½æ•°
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [TROUBLESHOOTING.md](./TROUBLESHOOTING.md) - è¯¦ç»†çš„é—®é¢˜æ’æŸ¥æ¡ˆä¾‹
- [Plasmo å®˜æ–¹æ–‡æ¡£ - CSUI](https://docs.plasmo.com/framework/content-scripts-ui)
- [Shadow DOM æ ·å¼éš”ç¦»](https://developer.mozilla.org/en-US/docs/Web/API/Web_components/Using_shadow_DOM)

---

## ğŸ“ æ›´æ–°æ—¥å¿—

| æ—¥æœŸ | å†…å®¹ |
|------|------|
| 2026-01-07 | åˆ›å»ºæ–‡æ¡£ï¼Œæ•´ç† CSS æ¶æ„ |
