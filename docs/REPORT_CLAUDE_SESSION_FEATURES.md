# Claude Session Key 功能开发报告

**日期**: 2026-01-13
**版本**: v1.0

## 1. 概述 (Overview)

本阶段的主要目标是为 Ophel 扩展实现 Claude 多账号（Session Key）管理功能。该功能允许用户存储多个 `sessionKey`，并能快速在不同账号间切换，主要解决了用户需要在不同 Claude 账号（如 Free, Pro, Team）之间频繁登录登出的痛点。

## 2. 当前工作进度 (Implementation Status)

核心功能已全部开发完成并经过测试。

### 2.1 核心管理功能

- [x] **Token 存储与管理**: 基于 Zustand (`claude-sessionkeys-store`) 实现了 Token 的增删改查。
- [x] **一键切换**: 用户点击切换按钮后，自动申请 Cookie 权限，修改 `claude.ai` 的 `sessionKey` Cookie，并刷新页面。
- [x] **账号有效性检测**: 通过调用 API (`/api/organizations`) 自动检测 Token 是否有效，并识别账号类型（Free / Pro / API / Team）。
- [x] **状态可视化**: 在列表中清晰展示每个 Token 的有效性状态、账号类型和截断后的 Key。

### 2.2 数据导入与导出

- [x] **从浏览器导入**: 支持一键读取当期浏览器登录的 `sessionKey` 并保存。
  - *优化*: 实现了权限检查流，点击时自动申请 `cookies` 权限。
- [x] **本地 JSON 备份**: 支持将所有 Session Keys 导出为 JSON 文件，或从 JSON 文件恢复。

### 2.3 WebDAV 云同步集成

- [x] **数据结构支持**: 扩展了 `storage.ts`，在 Store 中增加了 Session Keys 的持久化。
- [x] **完整备份支持**: 现有的 "完整备份" (Full Backup) 功能已自动包含 Session Keys 数据。用户通过 WebDAV 进行完整备份和恢复时，Session Keys 会同步恢复。

### 2.4 用户界面与体验 (UI/UX)

- [x] **独立设置面板**: 在 "站点设置" 中新增了 "Claude 专属" 标签页。
- [x] **权限引导**: 实现了友好的权限请求 UI。当功能需要 `cookies` 权限时，会弹出专门设计的请求窗口。
  - *修复*: 修复了此前 Cookie 权限请求错误显示为 WebDAV 权限说明的 Bug。
- [x] **国际化**: 全面支持 简体中文、繁体中文、English。

## 3. 存在的不足与限制 (Limitations)

尽管核心功能已就绪，但为了控制开发周期 (MVP)，部分非关键功能进行了简化或推迟。

### 3.1 快捷键功能 (已简化)

- **现状**: UI 上提示了 "支持快捷切换"，但目前只能通过点击 UI 按钮切换。
- **缺失**: 未实现全局快捷键（如 `Ctrl+Alt+k`）呼出快速切换菜单的功能。
- **原因**: 快捷键管理涉及 Content Script 注入和全局按键冲突处理，为了优先保证核心稳定性，此功能被标记为后续迭代 (Phase 2)。

### 3.2 WebDAV 粒度控制

- **现状**: Session Keys 只能通过 "完整备份" 进行云同步。
- **缺失**: 在 WebDAV 备份界面中，没有像 "仅提示词" 或 "仅设置" 那样单独勾选 "仅 Session Keys" 的选项。
- **影响**: 用户如果只想同步 Token 而不想覆盖其他设置，目前无法实现。

### 3.3 安全性提示

- **现状**: Session Keys 以明文形式存储在浏览器本地存储 (`chrome.storage.local`) 中。
- **风险**: 虽然这是标准的扩展存储方式，但导出 JSON 文件时包含敏感 Token。
- **建议**: 后续应在导出时增加醒目的安全警告，或支持导出加密文件。

## 4. 后续计划 (Next Steps / Roadmap)

1. **Phase 2: 快捷键增强**
    - 实现 Content Script 监听组合键。
    - 开发一个轻量级的 Overlay UI，在页面中央弹出 Token 选择列表，支持键盘上下选择。

2. **UI 细节优化**
    - 当 Token 数量较多时（>10），列表需要支持折叠或搜索。
    - 添加 "最后使用时间" 记录，方便清理过期 Token。

3. **自动化增强**
    - 考虑支持定时轮询检测所有 Token 的有效性（目前仅在点击 "测试" 或切换时检测）。

## 5. 总结

当前的实现版本是一个功能完整、体验闭环的 MVP (Minimum Viable Product)。能够完全满足用户 "一键切换账号" 的核心诉求，且具备基本的导入导出和云备份能力。已知的问题（如快捷键缺失）不影响核心功能的使用稳定性。
