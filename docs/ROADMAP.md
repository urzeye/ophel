# Ophel Extension Roadmap

> 待办事项和功能规划

---

## 🐛 Bug 修复

- [x] **提示词分类选择问题** ✅

  - 问题：更改提示词分类名后，没有默认选中的分类，所有提示词都查不出来，必须手动选一下分类
  - 修复：在 `handleRenameCategory` 中同步更新 `selectedCategory` 状态
  - 文件：`src/components/PromptsTab.tsx`

- [ ] **阅读历史恢复不准确**

  - 问题：阅读历史恢复功能不准确
  - 优先级：中

- [x] **Gemini Enterprise 滚动锁定无效** ✅

  - 问题：在 Gemini Enterprise (business.gemini.google) 站点上滚动锁定功能无效
  - 原因：主世界脚本缺少对 `Element.prototype.scrollTo/scroll/scrollBy` 的劫持
  - 修复：在 `scroll-lock-main.ts` 中补充三个元素级滚动 API 的劫持

- [x] **主题切换动画不同步** ✅

  - 问题：切换深浅主题时，圆形扩散动画还没完成前，面板框架（header/footer）已变成目标主题颜色，但中间的提示词列表、会话文件夹列表、输入框等仍保持原主题样式，视觉不一致
  - 修复：将 `onModeChange` 回调延迟到 `transition.finished` 之后，确保 React 重渲染不干扰 View Transition 动画
  - 文件：`src/core/theme-manager.ts`

- [x] **Gemini Enterprise 表格复制按钮** ✅
  - 问题：表格复制按钮在 Gemini Enterprise 不显示、点击无效果
  - 方案：为 Shadow DOM 站点添加定时扫描机制，使用内联样式和 JS 事件处理
  - 文件：`copy-manager.ts`, `main.ts`

---

## 🔧 重构

- [x] **布局设置命名空间统一** ✅

  - 内容：将 `pageWidth` 移入 `layout` 命名空间，与 `userQueryWidth` 统一管理
  - 文件：`storage.ts`, `SettingsTab.tsx`, `settings-schema.json`

- [x] **设置页面重构** ✅

  - 目标：优化设置页面的代码结构和用户体验
  - 优先级：中

- [ ] **会话 Tab 初始同步逻辑**
  - 问题：会话列表的初始同步逻辑需要优化
  - 优先级：中

---

## 🚀 待办优化 (Backlog)

### 权限与安全

- [ ] **优化权限申请逻辑**

  - 目标：遵从最小权限原则 (Least Privilege)
  - 内容：
    - 必需权限只保留 `storage` 等基础权限
    - 将其他逻辑移动到可选逻辑里
    - 增加权限校验：操作对应设置项时，如果未授权，动态提示去授权

- [ ] **WebDAV 恢复校验**
  - 问题：目前 WebDAV 恢复时未做数据完整性/格式校验
  - 目标：增加 JSON Schema 校验或基本格式检查

### UI/UX 体验优化

- [ ] **自定义样式编辑器优化**

  - 问题：当前弹窗太小，不方便编辑 CSS
  - 方案：优化弹窗尺寸，或改为非弹窗模式（如侧边栏展开/独立页面）

- [ ] **预置主题样式微调**

  - 问题：部分按钮/开关在特定主题下对比度不足，区别不明显
  - 目标：优化配色方案，提升可视性

- [ ] **细节样式优化**

  - 内容：优化 emoji 图标显示，统一样式细节

- [ ] **模型锁定排版优化**
  - 目标：改进模型锁定功能的 UI 布局

### 交互逻辑

- [ ] **设置页与自动吸附的交互**
  - 问题：点击设置时，面板不能自动吸附进去
  - 优化：当更新自动吸附开关状态后，应立即检测是否需要触发吸附逻辑

## 💡 提示词功能规划

### ✅ 已完成

- [x] **变量占位符** - 支持 `{{topic}}` 格式，插入时弹窗填写变量值
- [x] **收藏/置顶** - 手动置顶常用提示词
- [x] **导入/导出 JSON** - 数据迁移与备份（支持覆盖/合并）
- [x] **最近使用记录** - 自动记录并支持筛选
- [x] **分类颜色** - 根据分类名自动哈希生成颜色
- [x] **Markdown 预览** - 集成 markdown-it + highlight.js
- [x] **用户提问 Markdown 渲染** ✅
  - 场景：Gemini 把用户输入的 Markdown 按行拆分成 HTML，丢失了格式
  - 方案：提取文本 → 合并 → 用 markdown-it 渲染
  - 支持 Gemini 普通版和 Enterprise 版（Shadow DOM）
  - 包含代码块复制按钮、滚动条美化、深色模式适配

---

## 🎨 布局与样式

### ✅ 已完成

- [x] **用户问题容器宽度调整** ✅

  - 支持调整用户提问气泡的最大宽度（默认 600px）
  - 支持 Gemini 普通版和 Enterprise 版
  - 使用 `gh-` 前缀样式 ID，焦点离开后才应用（onBlur 模式）
  - 文件：`LayoutManager`, `storage.ts`, `SettingsTab.tsx`

- [x] **页面加宽功能** ✅
  - 支持调整聊天页面的宽度
  - 支持按站点独立配置

### P1 - 待实现

- [ ] **快捷键设置**

  - 支持用户自定义任意快捷键
  - 兼容 Mac（⌘）和 Windows（Ctrl）
  - 提供专门的快捷键设置面板

---

## 📝 更新日志

| 日期       | 内容                                           |
| ---------- | ---------------------------------------------- |
| 2026-01-07 | 修复 Gemini Enterprise 滚动锁定失效问题        |
| 2026-01-07 | 修复 Gemini Enterprise 表格复制按钮问题        |
| 2026-01-07 | 完成用户问题宽度调整功能                       |
| 2026-01-07 | 重构：布局设置统一到 layout 命名空间           |
| 2026-01-08 | 设置页重构完成：独立模态框、权限管理、数据同步 |
| 2026-01-07 | 完成用户提问 Markdown 渲染功能                 |
| 2026-01-06 | 更新提示词功能完成状态，添加快捷键设置规划     |
| 2026-01-06 | 添加提示词功能规划                             |
| 2026-01-06 | 创建 Roadmap 文档                              |
